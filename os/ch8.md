# 8 虚拟内存

## 8.1 硬件和控制结构

**常驻集**：进程执行的任何时候都在内存中的部分

**实存储器 real memory**

**虚拟内存 virtual memory**

### 8.1.1 局部性和虚拟内存

**转换检测缓冲区 Translation Lookaside Buffer TLB**

## 8.2 操作系统软件

### 8.2.3 置换策略

##### 页框锁定

一个页框被锁定时，保存在页框中的页不能被置换。内核和重要的控制结构，I/O缓冲区和其他对时间要求严格的区域都保存在锁定的页框中。

通过每个页框关联一个“锁定”位实现

##### 基本算法

* 最佳 OPT
* 最近最少使用 LRU
* 先进先出 FIFO
* **时钟 Clock**

LRU策略几乎与OPT策略相同，但是实现较为困难，而且需要大量的开销。FIFO策略实现简单，但性能相对较差。**时钟策略**原理上更接近FIFO，性能上试图以较小的开销接近LRU的性能。

##### 页缓冲

提高分页性能，允许使用较简单的页面置换策略。

VAX MAX方法

##### 高速缓存

### 8.2.4 驻留集管理

##### 驻留集大小

进程准备执行时，不需要把所有页都读入内存。操作系统必须决定读取多少页，需要考虑几个因素

* 分配给一个进程的内存越少，则可以驻留在内存中的进程数就越多
* 一个进程在内存中的页越少，缺页率越高
* 给进程分配的内存空间超过一定大小后，缺页率没有明显变化

##### 分配策略

* 固定分配策略，分配的页框数量在加载时就确定了
* 可变分配策略，页框数量可变

##### 置换范围

* 局部置换策略local replacement policy
* 全局置换策略global replacement policy

局部置换策略更易于分析，但不一定优于全局置换；全局置换实现简单，开销较小

|          | 局部置换                                                     | 全局置换                                                     |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 固定分配 | 分配给一个进程的页框数是固定的；从分配给进程的页框中选择被置换的页 | 无此方案                                                     |
| 可变分配 | 页框数可变，用于保存改进程的工作集；从分配给进程的页框中选择被置换的页 | 从所有可用页框中选择被置换的页；将导致进程驻留集的大小不断变化 |

**工作集策略 working set strategy**

**缺页终端频率算法 Page Fault Frequency, PFF**

**可变采样间隔工作集算法 Variable-interval Sampled Working Set, VSWS**

### 8.2.5 清除策略

* 请求式清除，只有当一页被选择用于置换时才写回辅存
* 预约式清除，在需要使用页框之前成批写回辅存

单独使用任何一种策略都不好，较好的方法是结合页缓冲技术。



## 8.4 Linux内存管理

##### 三级页表

* 页目录：每个活动进程有一个页目录；大小为一页；每项指向页中间目录中的一页；必须在内存中
* 页中间目录：大小为多页；每项指向页表中的一页
* 页表：大小为多页；每项指向该进程的一个虚拟页

Linux**页表**结构和平台无关

##### 页面分配

连续的页映射到连续的页框中

##### 页面置换算法

基于时钟算法